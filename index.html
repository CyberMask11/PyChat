<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PyChat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
--bg1:#050010;
--bg2:#1a0033;
--accent:#ff004c;
--accent2:#b300ff;
--glass:rgba(255,255,255,0.08);
--border:rgba(255,255,255,0.12);
--success:#00ff88;
--danger:#ff0033;
}

body{
margin:0;
font-family:Arial;
background:linear-gradient(135deg,var(--bg1),var(--bg2));
color:white;
overflow:hidden;
}

/* AUTH */

#authScreen{
height:100vh;
display:flex;
justify-content:center;
align-items:center;
}

.authCard{
width:400px;
padding:40px;
border-radius:20px;
background:var(--glass);
backdrop-filter:blur(25px);
border:1px solid var(--border);
box-shadow:0 0 30px rgba(255,0,80,0.2);
}

.authCard h2{
text-align:center;
margin-top:0;
}

input{
width:100%;
padding:12px;
margin-bottom:12px;
border:none;
border-radius:10px;
background:#14002a;
color:white;
}

button{
width:100%;
padding:12px;
border:none;
border-radius:10px;
cursor:pointer;
font-weight:bold;
background:linear-gradient(45deg,var(--accent),var(--accent2));
color:white;
}

button:hover{opacity:0.85;}

.switchMode{
text-align:center;
margin-top:10px;
cursor:pointer;
color:#aaa;
}

.errorMsg{
color:var(--danger);
font-size:14px;
text-align:center;
margin-bottom:10px;
}

/* DASHBOARD */

#dashboard{
display:none;
height:100vh;
flex-direction:column;
}

.header{
height:60px;
display:flex;
justify-content:space-between;
align-items:center;
padding:0 20px;
background:rgba(0,0,0,0.5);
border-bottom:1px solid var(--border);
}

.statusBox{
display:flex;
align-items:center;
gap:10px;
}

.statusDot{
width:10px;
height:10px;
border-radius:50%;
background:var(--danger);
}

.statusDot.connected{
background:var(--success);
}

.logoutBtn{
width:auto;
padding:8px 14px;
}

.mainContainer{
display:flex;
flex:1;
}

.userPanel{
width:250px;
border-right:1px solid var(--border);
padding:15px;
background:rgba(0,0,0,0.4);
overflow-y:auto;
}

.userItem{
padding:8px;
border-bottom:1px solid var(--border);
font-size:14px;
}

.chatPanel{
flex:1;
display:flex;
flex-direction:column;
}

.chatMessages{
flex:1;
overflow-y:auto;
padding:20px;
}

.message{
margin-bottom:15px;
padding:12px;
border-radius:12px;
background:rgba(255,255,255,0.08);
animation:fadeIn 0.3s ease;
}

.message.self{
background:rgba(255,0,80,0.25);
}

.message .meta{
font-size:12px;
color:#bbb;
margin-bottom:5px;
}

@keyframes fadeIn{
from{opacity:0;transform:translateY(5px);}
to{opacity:1;transform:translateY(0);}
}

.inputArea{
display:flex;
padding:15px;
background:rgba(0,0,0,0.5);
border-top:1px solid var(--border);
}

.inputArea input{
flex:1;
margin:0;
}

.sendBtn{
width:auto;
margin-left:10px;
}

/* Scrollbars */

::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-thumb{
background:var(--accent2);
border-radius:10px;
}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="authScreen">
<div class="authCard">
<h2 id="authTitle">Login</h2>
<div id="authError" class="errorMsg"></div>
<input id="displayname" placeholder="@displayname (Signup only)" style="display:none;">
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="handleAuth()">Submit</button>
<div class="switchMode" onclick="toggleMode()">Switch to Signup</div>
</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
<div class="header">
<div class="statusBox">
<div id="statusDot" class="statusDot"></div>
<span id="statusText">Disconnected</span>
</div>
<div>
<span id="currentUser"></span>
<button class="logoutBtn" onclick="logout()">Logout</button>
</div>
</div>

<div class="mainContainer">

<div class="userPanel">
<h3>Search Users</h3>
<input id="searchInput" placeholder="Search displayname">
<button onclick="searchUsers()">Search</button>
<div id="userResults"></div>
</div>

<div class="chatPanel">
<div id="chatMessages" class="chatMessages"></div>

<div class="inputArea">
<input id="chatInput" placeholder="Type message (Enter to send)">
<button class="sendBtn" onclick="sendMessage()">Send</button>
</div>
</div>

</div>
</div>

<script>
let mode="login";
let token=null;
let ws=null;
let usernameGlobal=null;
let reconnectTimer=null;
  
const API_BASE = `http://${location.hostname}:8080`;
const WS_BASE  = `ws://${location.hostname}:8080`;

/* MODE TOGGLE */
function toggleMode(){
mode=mode==="login"?"signup":"login";
document.getElementById("authTitle").innerText=mode==="login"?"Login":"Signup";
document.getElementById("displayname").style.display=mode==="signup"?"block":"none";
document.querySelector(".switchMode").innerText=
mode==="login"?"Switch to Signup":"Switch to Login";
document.getElementById("authError").innerText="";
}

/* AUTH */
async function handleAuth(){
const username=document.getElementById("username").value;
const password=document.getElementById("password").value;
const displayname=document.getElementById("displayname").value;

const endpoint=mode==="login"
?`${API_BASE}/auth/Login`
:`${API_BASE}/auth/SignUp`;

const payload=mode==="login"
?{username,password}
:{username,password,displayname};

const res=await fetch(endpoint,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(payload)
});

if(!res.ok){
document.getElementById("authError").innerText="Authentication failed.";
return;
}

const data=await res.json();

if(mode==="signup"){
alert("Signup successful. Now login.");
toggleMode();
return;
}

token=data.token;
usernameGlobal=username;

enterDashboard();
connectWebSocket();
}

/* DASHBOARD */
function enterDashboard(){
document.getElementById("authScreen").style.display="none";
document.getElementById("dashboard").style.display="flex";
document.getElementById("currentUser").innerText="User: "+usernameGlobal;
}

/* WEBSOCKET */
function connectWebSocket(){
if(ws) return;

ws=new WebSocket(`${WS_BASE}/ws?token=${token}`);

ws.onopen=()=>{
updateStatus(true);
};

ws.onclose=()=>{
updateStatus(false);
ws=null;
attemptReconnect();
};

ws.onerror=()=>{
updateStatus(false);
};

ws.onmessage=(event)=>{
addMessage(event.data,false);
};
}

function attemptReconnect(){
if(reconnectTimer) return;
reconnectTimer=setTimeout(()=>{
reconnectTimer=null;
connectWebSocket();
},3000);
}

function updateStatus(connected){
const dot=document.getElementById("statusDot");
const text=document.getElementById("statusText");
if(connected){
dot.classList.add("connected");
text.innerText="Connected";
}else{
dot.classList.remove("connected");
text.innerText="Disconnected";
}
}

/* CHAT */
function addMessage(text,self){
const container=document.getElementById("chatMessages");

const div=document.createElement("div");
div.className="message";
if(self) div.classList.add("self");

const meta=document.createElement("div");
meta.className="meta";
meta.innerText=new Date().toLocaleTimeString();

const content=document.createElement("div");
content.innerText=text;

div.appendChild(meta);
div.appendChild(content);
container.appendChild(div);
container.scrollTop=container.scrollHeight;
}

function sendMessage(){
const input=document.getElementById("chatInput");
const msg=input.value.trim();
if(!msg||!ws||ws.readyState!==WebSocket.OPEN) return;
ws.send(msg);
addMessage("You: "+msg,true);
input.value="";
}

document.getElementById("chatInput").addEventListener("keypress",function(e){
if(e.key==="Enter") sendMessage();
});

/* USER SEARCH */
async function searchUsers(){
const q=document.getElementById("searchInput").value;
const res=await fetch(`${API_BASE}/users?displayname=${q}`);
if(!res.ok) return;

const users=await res.json();
const container=document.getElementById("userResults");
container.innerHTML="";
users.forEach(u=>{
const div=document.createElement("div");
div.className="userItem";
div.innerText=u.displayname;
container.appendChild(div);
});
}

/* LOGOUT */
function logout(){
if(ws) ws.close();
location.reload();
}
</script>


</body>
</html>
